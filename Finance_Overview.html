<!DOCTYPE html>
<html lang="en">
    <head>    
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        
        <!-- Tabler CSS -->
        <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
        
        <!-- DataTables CSS -->
        <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
        
        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">    
    <!-- The Clearmin Dashboard CSS Libraries -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="Sources/Clearmin_Dashboard_All.css">


     <!-- JQuery Datapiker -->
    <script src="Sources/datepiker/jquery.js"></script>
    <script src="Sources/datepiker/jquery.datetimepicker.full.min.js"></script>
    <link rel="stylesheet" href="Sources/datepiker/jquery.datetimepicker.min.css">

    <style>
        /* Custom styles for chart and status alignment*/
        .page {
          display: flex;
          align-items: center; /* Vertically align status and chart */
          padding-top: 20px; /* add padding from top of the page */
          }

          .status-chart-container .card{
            display:flex;
          }
         .status-chart-container .card .card-body{
            display:flex;
         }
        #task-status-chart {
            max-height: 250px; /* Adjust for desired chart height */
        }

         .table-responsive{
            max-height:400px;
            overflow-y:auto;
         }


    </style>

   
    <title>Finance Overview</title>
    </head>


<body class="cm-no-transition cm-2-navbar cm-menu-toggled">

    <div id="cm-menu">
        <nav class="cm-navbar cm-navbar-turquoise">
            <div class="cm-flex"><a href="index.html" class="cm-logo"></a></div>
            <div class="btn btn-turquoise md-menu-white" data-toggle="cm-menu"></div>
        </nav>
            <div id="cm-menu-content">
                <div id="cm-menu-items-wrapper">
                    <div id="cm-menu-scroller">
                        <ul class="cm-menu-items">
                            <li class="cm-submenu">
                                <a class="sf-house">Main Dashboard <span class="caret"></span></a>
                                <ul>
                                    <li><a href="Main_Overview.html">Main Overview</a></li>
                                    <li><a href="Main_Gantt.html" >Main Gantt</a></li>
                                    <li><a href="Main_Grid.html">Main Grid</a></li>
                                    <li><a href="Main_Overview.html">Main Sheet</a></li>
                                    <li><a href="Main_PowerBi.html">Main PowerBi</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu" class="active">
                                <a class="sf-dashboard">Performane Dashboard <span class="caret"></span></a>
                                <ul>
                                    <li><a href="Performance_Overview.html" class="active">Performane Overview</a></li>
                                    <li><a href="Performance_Gantt.html" >Performane Gantt</a></li>
                                    <li><a href="Performance_Grid.html">Performane Grid</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-box-full">Documentation Dashboard <span class="caret"></span></a>
                                <ul>
                                    <li><a href="Documentation_Overview.html">Documentation Overview</a></li>
                                    <li><a href="Documentation_Gantt.html" class="active">Documentation Gantt</a></li>
                                    <li><a href="Documentation_Grid.html">Documentation Grid</a></li>
                                </ul>   
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-money">Finance Dashboard<span class="caret"></span></a>
                                <ul>
                                    <li><a href="Finance_Overview.html">Finance Overview</a></li>
                                    <li><a href="Finance_Gantt.html" class="active">Finance Gantt</a></li>
                                    <li><a href="Finance_Grid .html">Finance Grid</a></li>
                                    <li><a href="Finance_Tabulator.html">Finance Tabulator</a></li>
                                    <li><a href="Finance_PR_PO_Tracker.html" class="active">PR/PO Tracker</a></li>
                                    <li><a href="Finance_Expenses.html">Expenses Report</a></li>
                                    <li><a href="Finance_Trial_Balance.html">Trial Balance</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-monitor">MEAL Dashboard<span class="caret"></span></a>
                                <ul>
                                    <li><a href="MEAL_Overview.html">MEAL Overview</a></li>
                                    <li><a href="MEAL_Gantt.html" class="active">MEAL Gantt</a></li>
                                    <li><a href="MEAL_Grid.html">MEAL Grid</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-profile-group">HR Dashboard<span class="caret"></span></a>
                                <ul>
                                    <li><a href="HR_Overview.html">HR Overview</a></li>
                                    <li><a href="HR_Gantt.html" class="active">HR Gantt</a></li>
                                    <li><a href="HR_Grid.html">HR Grid</a></li>
                                </ul>
                            </li>                           
                            <li><a href="ChatWithAI.html" class="sf-terminal">Chat with AI</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <header id="cm-header">

            <nav class="cm-navbar cm-navbar-default cm-navbar-slideup">
                <div class="cm-flex">
                    <div class="nav-tabs-container">
                        <ul class="nav nav-tabs">
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="OverviewPage" class="active"><a  href="Finance_Overview.html">Finance Overview</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GanttPage"  ><a  href="Finance_Gantt.html">Finance Gantt</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage" ><a  href="Finance_Grid .html">Finance Grid</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage"><a  href="Finance_Tabulator.html">Finance Tabulator</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="OverviewPage" ><a  href="Finance_PR_PO_Tracker.html">PR/PO Tracker</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GanttPage"   ><a  href="Finance_Expenses.html">Expenses Report</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage"><a  href="Finance_Trial_Balance.html">Trial Balance</a></li>
                        </ul>
                    </div>
                </div>
                               
       
                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Edit Settings" class="btn btn-default btn-light md-settings" data-bs-toggle="offcanvas" href="#settingbtn" role="button" aria-controls="offcanvasRight"></a></div>
            </nav>


            
        </header>




        <div id="global">
          
          

                <div class="page">
                    <div class="container-xl">
                        <!-- Financial Summary Cards -->
                        <div class="row row-deck row-cards">
                            <div class="col-sm-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="subheader">Total Budget</div>
                                        </div>
                                        <div class="h1 mb-3" id="totalBudget">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="subheader">Total Spent</div>
                                        </div>
                                        <div class="h1 mb-3" id="totalSpent">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="subheader">PR Pending</div>
                                        </div>
                                        <div class="h1 mb-3" id="prPending">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="subheader">PO Completed</div>
                                        </div>
                                        <div class="h1 mb-3" id="poCompleted">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Financial Charts -->
                        <div class="row row-deck row-cards mt-3">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Budget Utilization</h3>
                                    </div>
                                    <div class="card-body" style="height: 300px">
                                        <canvas id="budgetChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Monthly Forecast</h3>
                                    </div>
                                    <div class="card-body" style="height: 300px">
                                        <canvas id="forecastChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Status Cards -->
                        <div class="row row-deck row-cards mt-3">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">PR Status Distribution</h3>
                                    </div>
                                    <div class="card-body" style="height: 280px">
                                        <canvas id="prStatusChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">PO Status Distribution</h3>
                                    </div>
                                    <div class="card-body" style="height: 280px">
                                        <canvas id="poStatusChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Filters -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <select id="prStatusFilter" class="form-select">
                                                    <option value="">All PR Statuses</option>
                                                    <option>Not Started</option>
                                                    <option>Prepared</option>
                                                    <option>submited</option>
                                                    <option>Canceled</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <select id="poStatusFilter" class="form-select">
                                                    <option value="">All PO Statuses</option>
                                                    <option>Not Started</option>
                                                    <option>Paid/Delivered</option>
                                                    <option>Archived/Done</option>
                                                    <option>Canceled</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Data Table -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h3 class="card-title">Financial Details</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="financialTable" class="table table-vcenter table-mobile-md card-table">
                                        <thead>
                                            <tr>
                                                <th>WBSCode</th>
                                                <th>Item</th>
                                                <th>Budget</th>
                                                <th>Spent</th>
                                                <th>Balance</th>
                                                <th>PR Status</th>
                                                <th>PO Status</th>
                                                <th>Forecast</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            

        


</div>


  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>


    <!-- The Clearmin Dashboard JavaScript Libraries -->
        <script src="Sources/Clearmin_Dashboard_All.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
   
   
        <script>
            document.addEventListener('DOMContentLoaded', async function() {
                const response = await fetch('https://fir-slickgrid-app-default-rtdb.firebaseio.com/tasks.json');
                const tasks = await response.json();
                const financialData = Object.values(tasks).map(task => ({
                    ...task,
                    The_Balance: (parseFloat(task.Total_Allocated_Budget_Item) || 0) - (parseFloat(task.Spent) || 0) // Calculate Balance here
                }));

                



                // Update Summary Cards
                document.getElementById('totalBudget').textContent =
                    financialData.reduce((sum, t) => sum + (parseFloat(t?.Total_Allocated_Budget_Item) || 0), 0).toLocaleString();
    
                document.getElementById('totalSpent').textContent =
                    financialData.reduce((sum, t) => sum + (parseFloat(t?.Spent) || 0), 0).toLocaleString();
    
                document.getElementById('prPending').textContent =
                    financialData.filter(t => t?.PR_Status === 'Prepared').length;
    
                document.getElementById('poCompleted').textContent =
                    financialData.filter(t => t?.PO_Status === 'Archeived/Done').length;
    
                // Initialize Charts
                new Chart(document.getElementById('budgetChart').getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['UnSpent', 'Spent'],
                        datasets: [{
                            data: [
                                financialData.reduce((a, t) => a + (parseFloat(t?.The_Balance) || 0), 0), // Using calculated balance
                                financialData.reduce((a, t) => a + (parseFloat(t?.Spent) || 0), 0),
                            ],
                            backgroundColor: ['#4bc0c0', '#ff6384', '#36a2eb']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
    
                // Forecast Chart (Monthly - No Change Here based on current understanding)
                const monthlyFC = Array.from({length: 12}, (_, i) =>
                    financialData.reduce((sum, t) => sum + (parseFloat(t[`${['Jan','Feb','Mar','Apr','May','Jun',
                        'Jul','Aug','Sep','Oct','Nov','Dec'][i]}_FC`]) || 0), 0)
                );
    
                new Chart(document.getElementById('forecastChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Monthly Forecast',
                            data: monthlyFC,
                            borderColor: '#4bc0c0',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
    
                // Status Charts
                const statusChart = (field, elementId) => {
                    const statuses = field === 'PR_Status' ?
                        ['Not Started', 'Prepared', 'Submited', 'Canceled'] :
                        ['Not Started', 'Paid/Deleivered', 'Archeived/Done', 'Canceled'];
    
                    return new Chart(document.getElementById(elementId).getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: statuses,
                            datasets: [{
                                data: statuses.map(s =>
                                    financialData.filter(t => t?.[field] === s).length),
                                backgroundColor: ['#868e96', '#ffd43b', '#40c057', '#fa5252']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                };
    
                statusChart('PR_Status', 'prStatusChart');
                statusChart('PO_Status', 'poStatusChart');
    
                // DataTable
                const table = $('#financialTable').DataTable({
                    data: financialData,
                    columns: [
                        {
                            data: 'WBS_Code',
                            render: data => data || '_'
                        },
                        {
                            data: 'Item_Name',
                            render: data => data || '_'
                        },
                        {
                            data: 'Total_Allocated_Budget_Item',
                            render: data => data ? `${parseFloat(data).toLocaleString()}` : '-'
                        },
                        {
                            data: 'Spent',
                            render: data => data ? `${parseFloat(data).toLocaleString()}` : '-'
                        },
                        {
                            data: 'The_Balance', // Data is already calculated as Budget - Spent
                            render: data => data ? `${parseFloat(data).toLocaleString()}` : '-'
                        },
                        {
                            data: 'PR_Status',
                            render: data => data || '_'
                        },
                        {
                            data: 'PO_Status',
                            render: data => data || '_'
                        },
                        {
                            // Calculate and display total forecast
                            render: function(data, type, row) {
                                let totalForecast = 0;
                                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                months.forEach(month => {
                                    totalForecast += parseFloat(row[`${month}_FC`] || 0);
                                });
                                return totalForecast.toLocaleString();
                            },
                            title: 'Forecast' // Set column title as 'Forecast'
                        }
                    ],
                    order: [],
                    ordering: true
                });
    
                // Filters
                document.getElementById('prStatusFilter').addEventListener('change', function() {
                    table.column(5).search(this.value).draw();
                });
    
                document.getElementById('poStatusFilter').addEventListener('change', function() {
                    table.column(6).search(this.value).draw();
                });
            });
        </script>
    
   
   
   
    </body>
</html>

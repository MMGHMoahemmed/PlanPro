<!DOCTYPE html>
<html lang="en">
    <head>
    <!-- Firebase SDK (Compact) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">    
    <!-- The Clearmin Dashboard CSS Libraries -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=1024">
    <link rel="stylesheet" type="text/css" href="Sources/Clearmin_Dashboard_All.css">


     <!-- JQuery Datapiker -->
    <script src="Sources/datepiker/jquery.js"></script>
    <script src="Sources/datepiker/jquery.datetimepicker.full.min.js"></script>
    <link rel="stylesheet" href="Sources/datepiker/jquery.datetimepicker.min.css">
    <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">


    <style>
      body {
          font-family: sans-serif;
      }
 
  </style>


    <!-- Tabulator JS -->


    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>


    <title>Trial Balance</title>
    </head>







  
  
<body class="cm-no-transition cm-2-navbar cm-menu-toggled">
        <div id="cm-menu">
            <nav class="cm-navbar cm-navbar-turquoise">
                <div class="cm-flex"><a href="index.html" class="cm-logo"></a></div>
                <div class="btn btn-turquoise md-menu-white" data-toggle="cm-menu"></div>
            </nav>
            <div id="cm-menu-content">
                <div id="cm-menu-items-wrapper">
                    <div id="cm-menu-scroller">
                        <ul class="cm-menu-items">
                            <li class="cm-submenu">
                                <a class="sf-house">Main Dashboard <span class="caret"></span></a>
                                <ul>
                                    <li><a href="Main_Overview.html">Main Overview</a></li>
                                    <li><a href="Main_Gantt.html" >Main Gantt</a></li>
                                    <li><a href="Main_Grid.html">Main Grid</a></li>
                                    <li><a href="Main_Overview.html">Main Sheet</a></li>
                                    <li><a href="Main_PowerBi.html">Main PowerBi</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu" class="active">
                                <a class="sf-dashboard">Performane Dashboard <span class="caret"></span></a>
                                <ul>
                                    <li><a href="Performance_Overview.html" class="active">Performane Overview</a></li>
                                    <li><a href="Performance_Gantt.html" >Performane Gantt</a></li>
                                    <li><a href="Performance_Grid.html">Performane Grid</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-box-full">Documentation Dashboard <span class="caret"></span></a>
                                <ul>
                                    <li><a href="Documentation_Overview.html">Documentation Overview</a></li>
                                    <li><a href="Documentation_Gantt.html" class="active">Documentation Gantt</a></li>
                                    <li><a href="Documentation_Grid.html">Documentation Grid</a></li>
                                </ul>   
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-money">Finance Dashboard<span class="caret"></span></a>
                                <ul>
                                    <li><a href="Finance_Overview.html">Finance Overview</a></li>
                                    <li><a href="Finance_Gantt.html" class="active">Finance Gantt</a></li>
                                    <li><a href="Finance_Grid .html">Finance Grid</a></li>
                                    <li><a href="Finance_Tabulator.html">Finance Tabulator</a></li>
                                    <li><a href="Finance_PR_PO_Tracker.html" class="active">PR/PO Tracker</a></li>
                                    <li><a href="Finance_Expenses.html">Expenses Report</a></li>
                                    <li><a href="Finance_Trial_Balance.html">Trial Balance</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-monitor">MEAL Dashboard<span class="caret"></span></a>
                                <ul>
                                    <li><a href="MEAL_Overview.html">MEAL Overview</a></li>
                                    <li><a href="MEAL_Gantt.html" class="active">MEAL Gantt</a></li>
                                    <li><a href="MEAL_Grid.html">MEAL Grid</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-profile-group">HR Dashboard<span class="caret"></span></a>
                                <ul>
                                    <li><a href="HR_Overview.html">HR Overview</a></li>
                                    <li><a href="HR_Gantt.html" class="active">HR Gantt</a></li>
                                    <li><a href="HR_Grid.html">HR Grid</a></li>
                                </ul>
                            </li>                           
                            <li><a href="ChatWithAI.html" class="sf-terminal">Chat with AI</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <header id="cm-header">

            <nav class="cm-navbar cm-navbar-default cm-navbar-slideup">
                <div class="cm-flex">
                    <div class="nav-tabs-container">
                        <ul class="nav nav-tabs">
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="OverviewPage" ><a  href="Finance_Overview.html">Finance Overview</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GanttPage"  ><a  href="Finance_Gantt.html">Finance Gantt</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage" ><a  href="Finance_Grid .html">Finance Grid</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage" ><a  href="Finance_Tabulator.html">Finance Tabulator</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="OverviewPage" ><a  href="Finance_PR_PO_Tracker.html">PR/PO Tracker</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GanttPage"   ><a  href="Finance_Expenses.html">Expenses Report</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage" class="active"><a  href="Finance_Trial_Balance.html">Trial Balance</a></li>
                        </ul>
                    </div>
                </div>
          
              
                         
       

                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Actions" class="btn btn-default btn-light md-tune" data-bs-toggle="offcanvas" href="#actions" role="button" aria-controls="offcanvasRight"></a></div>
                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Filter Content" class="btn btn-default btn-light md-filter-list" data-bs-toggle="offcanvas" href="#filters" role="button" aria-controls="offcanvasRight"></a></div>
                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Edit Layout" class="btn btn-default btn-light md-palette" data-bs-toggle="offcanvas" href="#layout" role="button" aria-controls="offcanvasRight"></a></div>
                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Manage Colmuns" class="btn btn-default btn-light md-remove-red-eye" data-toggle="modal" data-target="#colmuns" role="button"></a></div>
                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Edit Settings" class="btn btn-default btn-light md-settings" data-bs-toggle="offcanvas" href="#settingbtn" role="button" aria-controls="offcanvasRight"></a></div>
            </nav>


            
        </header>





          
   <div id="example-table" class=" cm-container-white container-fluid" style="height: 100%; width: 100%; position: relative;"></div>

       


        <div class="offcanvas offcanvas-end" tabindex="-1" id="actions" aria-labelledby="offcanvasRightLabel">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasRightLabel">Actions</h5>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
              Actions
            </div>
          
          
          
            
          </div>

        <div class="offcanvas offcanvas-end" tabindex="-1" id="filters" aria-labelledby="offcanvasRightLabel">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasRightLabel">Filters</h5>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
              Filter
            </div>
          
          
          
            
          </div>


        <div class="offcanvas offcanvas-end" tabindex="-1" id="layout" aria-labelledby="offcanvasRightLabel">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasRightLabel">Edit Layout</h5>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
              Edit Layouts
            </div>
          
          
          
            
          </div>


        
        <div class="offcanvas offcanvas-end" tabindex="-1" id="settingbtn" aria-labelledby="offcanvasRightLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasRightLabel">Settings</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    Settings
  </div>




</div>

 

<script>
  // Firebase Configuration (Replace with your actual config)
  const firebaseConfig = {
      apiKey: "AIzaSyByY_StlwAyml1ZzhTjT9hxAZJIEUpYOYI",
      authDomain: "fir-slickgrid-app.firebaseapp.com",
      databaseURL: "https://fir-slickgrid-app-default-rtdb.firebaseio.com",
      projectId: "fir-slickgrid-app",
      storageBucket: "fir-slickgrid-app.firebasestorage.app",
      messagingSenderId: "632345189503",
      appId: "1:632345189503:web:5ea427e9d8ce2ea5cc734a"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database(app);
  const dbRef = firebase.database().ref('tasks'); // Path in your Firebase Realtime Database

  var tableData = []; // Will be populated from Firebase
  var nestedTableData = []; // Will store nested data





var MainProWBS = function(values, data, calcParams){


var wps = "0";

return wps;
}


var mainProName = function(values, data, calcParams){


var Name = "The Main Project";

return Name;
}









  // Function to transform flat data into nested structure based on WBS_Code
  function transformDataToNested(data) {
      const nestedData = [];
      const codeMap = {};

      data.forEach(item => {
          const wbsCode = item.WBS_Code;
          const parts = wbsCode.split('.');
          let currentLevel = nestedData;
          let currentCode = '';

          for (let i = 0; i < parts.length; i++) {
              const part = parts[i];
              const levelCode = currentCode ? `${currentCode}.${part}` : part;
              let existingItem = codeMap[levelCode];

              if (!existingItem) {
                  // Lookup the correct data item from 'data' based on levelCode
                  const levelDataItem = data.find(d => d.WBS_Code === levelCode);

                  if (levelDataItem) {
                      existingItem = { ...levelDataItem, id: levelDataItem.id, _children: [] };
                      console.log("transformDataToNested - Creating item:", levelCode, "Text:", levelDataItem.text, "New Item Text:", existingItem.text); // Text Logging
                      codeMap[levelCode] = existingItem;

                      if (currentCode) {
                          const parentItem = codeMap[currentCode];
                          if (parentItem) {
                              parentItem._children.push(existingItem);
                          }
                      } else {
                          currentLevel.push(existingItem);
                      }
                  } else {
                      console.warn("transformDataToNested - Data item not found for WBS_Code:", levelCode);
                  }
              }
              currentLevel = existingItem._children;
              currentCode = levelCode;
          }
      });

      // Filter out items that are only intermediate nodes
      function filterIntermediateNodes(items) {
          return items.filter(item => {
              if (item._children && item._children.length > 0) {
                  item._children = filterIntermediateNodes(item._children);
                  return item.text || item.Total_Allocated_Budget_Item || item._children.length > 0;
              }
              return true;
          });
      }

      const filteredNestedData = filterIntermediateNodes(nestedData);

      // Function to aggregate Spent and Allocated Budget
      function aggregateValues(items) {
          items.forEach(item => {
              let aggregatedSpent = 0;
              let aggregatedBudget = 0;

              if (item._children && item._children.length > 0) {
                  aggregateValues(item._children); // Recursive call for children
                  item._children.forEach(child => {
                      aggregatedSpent += parseFloat(child.Spent || 0);
                      aggregatedBudget += parseFloat(child.Total_Allocated_Budget_Item || 0);
                  });
              }

              // Add own values if they exist, otherwise use aggregated values
              item.Spent = (parseFloat(item.Spent || 0) || 0) + aggregatedSpent;
              item.Total_Allocated_Budget_Item = (parseFloat(item.Total_Allocated_Budget_Item || 0) || 0) + aggregatedBudget;
              item.The_Balance = item.Total_Allocated_Budget_Item - item.Spent; // Update The_Balance here as well
              item.Precentage = item.Total_Allocated_Budget_Item > 0 ? (item.Spent / item.Total_Allocated_Budget_Item) * 100 : 0; // Update Precentage here as well

              if (isNaN(item.Spent)) item.Spent = 0; // Handle NaN if aggregation results in NaN
              if (isNaN(item.Total_Allocated_Budget_Item)) item.Total_Allocated_Budget_Item = 0; // Handle NaN if aggregation results in NaN
              if (isNaN(item.The_Balance)) item.The_Balance = 0; // Handle NaN if aggregation results in NaN
              if (isNaN(item.Precentage)) item.Precentage = 0; // Handle NaN if aggregation results in NaN
          });
      }

      aggregateValues(filteredNestedData); // Aggregate values after filtering

      return filteredNestedData;
  }


  // Custom bottomCalc function to sum values in the entire tree (Keep it for total footer sum if needed)
  var customTreeSum = function(values, data, calcParams){
      let sum = 0;

      function recursiveSum(items) {
          items.forEach(item => {
              let value = parseFloat(item[calcParams.field]); // Parse value as float
              if (!isNaN(value)) { // Check if value is a number
                  sum += value;
              }
              if (item._children && item._children.length > 0) {
                  recursiveSum(item._children); // Recurse into children
              }
          });
      }

      recursiveSum(nestedTableData); // Use the globally available nestedTableData
      return sum;
  };


  var table = new Tabulator("#example-table", {
      height: "100%",
      data: [], // Initial empty data, will be loaded from Firebase
      dataTree: true,
      //dataTreeStartExpanded: true,
      dataTreeElementColumn: "text",
      layout: "fitColumns",
      movableColumns: true,
      columns: [

          { title: "WBS Code", field: "WBS_Code", width: 170, hozAlign:"center", topCalc:MainProWBS,  editable:false,frozen:true },
          { title: "ITEM NAME", field: "text", width: 650, editable: false, topCalc:mainProName,  frozen:true }, // Header Filter enabled

        //  { title: "Finance Code", field: "Fin_Code", width: 100, editable: true,headerFilter:true },
//{ title: "Item Name", field: "Item_Name", width: 100, editable: true, headerFilter:true },
       //   { title: "Budget Item Name", field: "Budget_Item_Name", width: 100, editable: true, headerFilter:true },
       //   { title: "Parent Item Name", field: "Parent_Item", width: 100, editable: true, headerFilter:true  },


          { title: "Total Budget", field: "Total_Allocated_Budget_Item", topCalc:"sum",  width: 170, hozAlign:"center",  editor:"number", editable: false,  mutateLink:"The_Balance",mutator:function(value, data){

if (value === undefined){
  return  0 ;
} else {
  return Number(value);

}

},formatter:function(cell, formatterParams, onRendered){
              var Total_Allocated_Budget_Item = cell.getValue();

                  return "$" + Total_Allocated_Budget_Item; //return the contents of the cell;

              }}, // Custom Footer Sum
          { title: "Spent", field: "Spent", topCalc:"sum",  width: 170, hozAlign:"center",  editor:"number", editable: false,  mutateLink:"The_Balance",mutator:function(value, data){

if (value === undefined){
  return  0 ;
} else {
  return Number(value);

}

},formatter:function(cell, formatterParams, onRendered){
              var Spent = cell.getValue();

                  return "$" + Spent; //return the contents of the cell;

              } },
          { title: "The Balance", field: "The_Balance", topCalc:"sum",  width: 170,  hozAlign:"center", editor:"number", editable: false , mutator:function(value, data){

              if (value === undefined){
                      return  0 ;
                  } else {
                      return data.Total_Allocated_Budget_Item - data.Spent;

                  }

           },formatter:function(cell, formatterParams, onRendered){
              var The_Balance = cell.getValue();

                  return "$" + The_Balance; //return the contents of the cell;

              }  },
          // Custom Footer Sum
          { title: "Precentage", field: "Precentage", topCalc:"avg",  width: 170,  hozAlign:"center", editor:"number", editable: false, mutator:function(value, data){

          if (value === undefined){
                  return  0 ;
              } else {
                  return (+data.Spent / +data.Total_Allocated_Budget_Item) * 100;

              }

          },formatter:function(cell, formatterParams, onRendered){
              var Precentage = cell.getValue();

                  return Precentage + "%"; //return the contents of the cell;

              }  }, // Custom Footer Sum


      ],

  });


  // Load data from Firebase and update table
  dbRef.on('value', (snapshot) => {
      let firebaseData = snapshot.val();
      if (firebaseData) {
          // Convert Firebase object to array and transform to nested structure
          const dataArray = Object.keys(firebaseData).map(key => ({
              id: key, // Keep Firebase key as 'id' for updates/deletes
              ...firebaseData[key]
          }));

          nestedTableData = transformDataToNested(dataArray);
          console.log("Nested Table Data after transformation:", nestedTableData);

          table.replaceData(nestedTableData);
      } else {
          table.replaceData([]);
      }
  }, (errorObject) => {
      console.error("Data read failed: " + errorObject.name);
  });


</script>




<footer class="cm-footer" style = "height:1px">

  
</footer>




<!-- The Clearmin Dashboard JavaScript Libraries -->
<script src="Sources/Clearmin_Dashboard_All.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>


</body>      
</html>

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

   <!-- Firebase -->
   <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
   <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

        <!-- Required CSS in exact order -->
        <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/css/pluginsCss.css' />
        <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/css/luckysheet.css' />
        <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/assets/iconfont/iconfont.css' />


    <!-- EXACT script order is crucial -->
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/luckysheet.umd.js"></script>        




        <!-- Tabler CSS -->

    
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">    
    <!-- The Clearmin Dashboard CSS Libraries -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="Sources/Clearmin_Dashboard_All.css">


     <!-- JQuery Datapiker -->
    <script src="Sources/datepiker/jquery.js"></script>
    <script src="Sources/datepiker/jquery.datetimepicker.full.min.js"></script>
    <link rel="stylesheet" href="Sources/datepiker/jquery.datetimepicker.min.css">





    <style>
#luckysheet { 
    margin: 0px; 
    height: 92vh;
    width: 100%;
    position: relative;
} 
#global{
margin-left: 50px;

}   
   
    
    </style>


    <title>Main Sheet</title>
    </head>


<body class="cm-no-transition cm-2-navbar cm-menu-toggled">

    <div id="cm-menu">
        <nav class="cm-navbar cm-navbar-turquoise">
            <div class="cm-flex"><a href="index.html" class="cm-logo"></a></div>
            <div class="btn btn-turquoise md-menu-white" data-toggle="cm-menu"></div>
        </nav>
        <div id="cm-menu-content">
            <div id="cm-menu-items-wrapper">
                <div id="cm-menu-scroller">
                    <ul class="cm-menu-items">
                        <li class="cm-submenu">
                            <a class="sf-house">Main Dashboard <span class="caret"></span></a>
                            <ul>
                                <li><a href="Main_Overview.html">Main Overview</a></li>
                                <li><a href="Main_Gantt.html" >Main Gantt</a></li>
                                <li><a href="Main_Grid.html">Main Grid</a></li>
                                <li><a href="Main_Overview.html">Main Sheet</a></li>
                                <li><a href="Main_PowerBi.html">Main PowerBi</a></li>
                            </ul>
                        </li>
                        <li class="cm-submenu" class="active">
                            <a class="sf-dashboard">Performane Dashboard <span class="caret"></span></a>
                            <ul>
                                <li><a href="Performance_Overview.html" class="active">Performane Overview</a></li>
                                <li><a href="Performance_Gantt.html" >Performane Gantt</a></li>
                                <li><a href="Performance_Grid.html">Performane Grid</a></li>
                            </ul>
                        </li>
                        <li class="cm-submenu"><a href="#" class="sf-box-full">Documentation Dashboard <span class="caret"></span></a>
                            <ul>
                                <li><a href="Documentation_Overview.html">Documentation Overview</a></li>
                                <li><a href="Documentation_Gantt.html" class="active">Documentation Gantt</a></li>
                                <li><a href="Documentation_Grid.html">Documentation Grid</a></li>
                            </ul>   
                        </li>
                        <li class="cm-submenu"><a href="#" class="sf-money">Finance Dashboard<span class="caret"></span></a>
                            <ul>
                                <li><a href="Finance_Overview.html">Finance Overview</a></li>
                                <li><a href="Finance_Gantt.html" class="active">Finance Gantt</a></li>
                                <li><a href="Finance_Grid .html">Finance Grid</a></li>
                                <li><a href="Finance_Tabulator.html">Finance Tabulator</a></li>
                                <li><a href="Finance_PR_PO_Tracker.html" class="active">PR/PO Tracker</a></li>
                                <li><a href="Finance_Expenses.html">Expenses Report</a></li>
                                <li><a href="Finance_Trial_Balance.html">Trial Balance</a></li>
                            </ul>
                        </li>
                        <li class="cm-submenu"><a href="#" class="sf-monitor">MEAL Dashboard<span class="caret"></span></a>
                            <ul>
                                <li><a href="MEAL_Overview.html">MEAL Overview</a></li>
                                <li><a href="MEAL_Gantt.html" class="active">MEAL Gantt</a></li>
                                <li><a href="MEAL_Grid.html">MEAL Grid</a></li>
                            </ul>
                        </li>
                        <li class="cm-submenu"><a href="#" class="sf-profile-group">HR Dashboard<span class="caret"></span></a>
                            <ul>
                                <li><a href="HR_Overview.html">HR Overview</a></li>
                                <li><a href="HR_Gantt.html" class="active">HR Gantt</a></li>
                                <li><a href="HR_Grid.html">HR Grid</a></li>
                            </ul>
                        </li>                           
                        <li><a href="ChatWithAI.html" class="sf-terminal">Chat with AI</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

        <header id="cm-header">

            <nav class="cm-navbar cm-navbar-default cm-navbar-slideup">
                <div class="cm-flex">
                    <div class="nav-tabs-container">
                        <ul class="nav nav-tabs">
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="OverviewPage" ><a  href="Main_Overview.html">Main Overview</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GanttPage"><a  href="Main_Gantt.html">Main Gantt</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage"><a  href="Main_Grid.html">Main Grid</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage" class="active" ><a  href="Main_Sheet.html">Main Sheet</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage"  ><a  href="Main_PowerBi.html">Main PowerBI</a></li>
                        </ul>
                    </div>
                </div>
                               
       
                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Edit Settings" class="btn btn-default btn-light md-settings" data-bs-toggle="offcanvas" href="#settingbtn" role="button" aria-controls="offcanvasRight"></a></div>
            </nav>


            
        </header>




        <div id="global">
          
  
                <div id="luckysheet" class="container-fluid" ></div>
                    
        </div>


</div>


<script>
    // Add these functions ABOVE the initialization code
    // --------------------------------------------------
    // 1. Data Conversion Functions
    function processFirebaseData(firebaseData) {
        try {
            const items = Object.values(firebaseData);
            if (items.length === 0) return [createEmptySheet()];
    
            const headers = extractHeaders(items[0]);
            return [createSheetData(headers, items)];
        } catch (error) {
            console.error('Data conversion failed:', error);
            return [createErrorSheet(error)];
        }
    }
    
    function extractHeaders(item) {
  
  
        var heads = {WBS_Code:'', text: '', priority:'', progress:'', status:'', start_date:'',end_date:'', duration:'', public_comments:'', private_comments:'', notes: ''};
        return Object.keys(heads).filter(key => 
            !['id', 'parent'].includes(key) // Exclude internal fields
          
        );
  
    }
    
    function createSheetData(headers, items) {
        return {
            name: "Main",
            celldata: [
                // Header row
                headers.map((header, col) => ({
                    r: 0, 
                    c: col, 
                    v: header.replace(/_/g, ' ').trim()
                })),
                // Data rows
                ...items.map((item, row) => 
                    headers.map((header, col) => ({
                        r: row + 1,
                        c: col,
                        v: formatCellValue(item[header], header)
                    }))
                )
            ].flat(2)
        };
    }
    
    function formatCellValue(value, header) {
        // Handle special field types
        if (typeof value === 'string' && value.trim() === '') return null;
        if (header.toLowerCase().includes('date')) {
            return value ? new Date(value).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
        }
        if (header === 'progress') return parseFloat(value) || 0;
        return value;
    }
    
    function createEmptySheet() {
        return {
            name: "Empty",
            celldata: [{ r: 0, c: 0, v: "No data available" }]
        };
    }
    
    function createErrorSheet(error) {
        return {
            name: "Error",
            celldata: [
                { r: 0, c: 0, v: "Data Loading Error" },
                { r: 1, c: 0, v: error.message }
            ]
        };
    }
    
  
  
  
    // 2. Keep the existing initialization code BELOW
    // ----------------------------------------------
    function initApp() {
        /* existing initialization code */
    }
    
    function initSheet(data) {
        /* updated code with error handling */
    luckysheet.create({
                container: 'luckysheet',
                data: processFirebaseData(data),
                showinfobar: false,
                lang: 'en'
            });
    }
    
    // Rest of your code...
    </script>
  
  
  
  
  
  
  
  <script>
    // 1. Verify Luckysheet loading first
    console.log('Luckysheet available:', !!window.luckysheet);
    
    // 2. Modified initialization flow
    function initApp() {
        // Force wait for Luckysheet
        if (!window.luckysheet) {
            console.error('Luckysheet not found in global scope');
            return;
        }
  
        // Initialize Firebase
        const firebaseConfig = {apiKey: "AIzaSyByY_StlwAyml1ZzhTjT9hxAZJIEUpYOYI",
  authDomain: "fir-slickgrid-app.firebaseapp.com",
  databaseURL: "https://fir-slickgrid-app-default-rtdb.firebaseio.com",
  projectId: "fir-slickgrid-app",
  storageBucket: "fir-slickgrid-app.firebasestorage.app",
  messagingSenderId: "632345189503",
  appId: "1:632345189503:web:5ea427e9d8ce2ea5cc734a"};
        firebase.initializeApp(firebaseConfig);
        
        // Load data
        const dbRef = firebase.database().ref('tasks');
        dbRef.on('value', (snapshot) => {
            const data = snapshot.val() || {};
            initSheet(data);
        });
    }
  
    // 3. Sheet initialization with error handling
    function initSheet(data) {
               luckysheet.create({
                container: 'luckysheet',
                data: processFirebaseData(data),
                showinfobar: false,
                lang: 'en',
                plugins: ['chart']
            });
    }
  
  
            initApp();
  
  </script>
  
  
  

    <!-- The Clearmin Dashboard JavaScript Libraries -->
        <script src="Sources/Clearmin_Dashboard_All.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    </body>
</html>

<!DOCTYPE html>
<html lang="en">
    <head>
    <!-- Firebase SDK (Compact) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">    
    <!-- The Clearmin Dashboard CSS Libraries -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="Sources/Clearmin_Dashboard_All.css">


     <!-- JQuery Datapiker -->
    <script src="Sources/datepiker/jquery.js"></script>
    <script src="Sources/datepiker/jquery.datetimepicker.full.min.js"></script>
    <link rel="stylesheet" href="Sources/datepiker/jquery.datetimepicker.min.css">
    <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">


    <style>
      body {
          font-family: sans-serif;
      }
 
  </style>


    <!-- Tabulator JS -->


    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>


    <title>Expenses Report</title>
    </head>







  
  
<body class="cm-no-transition cm-2-navbar cm-menu-toggled">
        <div id="cm-menu">
            <nav class="cm-navbar cm-navbar-turquoise">
                <div class="cm-flex"><a href="index.html" class="cm-logo"></a></div>
                <div class="btn btn-turquoise md-menu-white" data-toggle="cm-menu"></div>
            </nav>
            <div id="cm-menu-content">
                <div id="cm-menu-items-wrapper">
                    <div id="cm-menu-scroller">
                        <ul class="cm-menu-items">
                            <li class="cm-submenu">
                                <a class="sf-house">Main Dashboard <span class="caret"></span></a>
                                <ul>
                                    <li><a href="Main_Overview.html">Main Overview</a></li>
                                    <li><a href="Main_Gantt.html" >Main Gantt</a></li>
                                    <li><a href="Main_Grid.html">Main Grid</a></li>
                                    <li><a href="Main_Overview.html">Main Sheet</a></li>
                                    <li><a href="Main_PowerBi.html">Main PowerBi</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu" class="active">
                                <a class="sf-dashboard">Performane Dashboard <span class="caret"></span></a>
                                <ul>
                                    <li><a href="Performance_Overview.html" class="active">Performane Overview</a></li>
                                    <li><a href="Performance_Gantt.html" >Performane Gantt</a></li>
                                    <li><a href="Performance_Grid.html">Performane Grid</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-box-full">Documentation Dashboard <span class="caret"></span></a>
                                <ul>
                                    <li><a href="Documentation_Overview.html">Documentation Overview</a></li>
                                    <li><a href="Documentation_Gantt.html" class="active">Documentation Gantt</a></li>
                                    <li><a href="Documentation_Grid.html">Documentation Grid</a></li>
                                </ul>   
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-money">Finance Dashboard<span class="caret"></span></a>
                                <ul>
                                    <li><a href="Finance_Overview.html">Finance Overview</a></li>
                                    <li><a href="Finance_Gantt.html" class="active">Finance Gantt</a></li>
                                    <li><a href="Finance_Grid .html">Finance Grid</a></li>
                                    <li><a href="Finance_Tabulator.html">Finance Tabulator</a></li>
                                    <li><a href="Finance_PR_PO_Tracker.html" class="active">PR/PO Tracker</a></li>
                                    <li><a href="Finance_Expenses.html">Expenses Report</a></li>
                                    <li><a href="Finance_Trial_Balance.html">Trial Balance</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-monitor">MEAL Dashboard<span class="caret"></span></a>
                                <ul>
                                    <li><a href="MEAL_Overview.html">MEAL Overview</a></li>
                                    <li><a href="MEAL_Gantt.html" class="active">MEAL Gantt</a></li>
                                    <li><a href="MEAL_Grid.html">MEAL Grid</a></li>
                                </ul>
                            </li>
                            <li class="cm-submenu"><a href="#" class="sf-profile-group">HR Dashboard<span class="caret"></span></a>
                                <ul>
                                    <li><a href="HR_Overview.html">HR Overview</a></li>
                                    <li><a href="HR_Gantt.html" class="active">HR Gantt</a></li>
                                    <li><a href="HR_Grid.html">HR Grid</a></li>
                                </ul>
                            </li>                           
                            <li><a href="ChatWithAI.html" class="sf-terminal">Chat with AI</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <header id="cm-header">

            <nav class="cm-navbar cm-navbar-default cm-navbar-slideup">
                <div class="cm-flex">
                    <div class="nav-tabs-container">
                        <ul class="nav nav-tabs">
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="OverviewPage" ><a  href="Finance_Overview.html">Finance Overview</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GanttPage"><a  href="Finance_Gantt.html">Finance Gantt</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage"><a  href="Finance_Grid .html">Finance Grid</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage"><a  href="Finance_Tabulator.html">Finance Tabulator</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="OverviewPage" ><a  href="Finance_PR_PO_Tracker.html">PR/PO Tracker</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GanttPage"  class="active" ><a  href="Finance_Expenses.html">Expenses Report</a></li>
                            <li style="border-left:1px solid #e5e5e5; border-right:1px solid #e5e5e5" id="GridPage"><a  href="Finance_Trial_Balance.html">Trial Balance</a></li>
                        </ul>
                    </div>
                </div>
          
              
                         
       

                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Actions" class="btn btn-default btn-light md-tune" data-bs-toggle="offcanvas" href="#actions" role="button" aria-controls="offcanvasRight"></a></div>
                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Filter Content" class="btn btn-default btn-light md-filter-list" data-bs-toggle="offcanvas" href="#filters" role="button" aria-controls="offcanvasRight"></a></div>
                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Edit Layout" class="btn btn-default btn-light md-palette" data-bs-toggle="offcanvas" href="#layout" role="button" aria-controls="offcanvasRight"></a></div>
                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Manage Colmuns" class="btn btn-default btn-light md-remove-red-eye" data-toggle="modal" data-target="#colmuns" role="button"></a></div>
                <div class="pull-right" style="border-left:1px solid #e5e5e5"><a title="Edit Settings" class="btn btn-default btn-light md-settings" data-bs-toggle="offcanvas" href="#settingbtn" role="button" aria-controls="offcanvasRight"></a></div>
            </nav>


            
        </header>





          
   <div id="example-table" class=" cm-container-white container-fluid" style="height: 100%; width: 100%; position: relative;"></div>

       


        <div class="offcanvas offcanvas-end" tabindex="-1" id="actions" aria-labelledby="offcanvasRightLabel">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasRightLabel">Actions</h5>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
              Actions
            </div>
          
          
          
            
          </div>

        <div class="offcanvas offcanvas-end" tabindex="-1" id="filters" aria-labelledby="offcanvasRightLabel">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasRightLabel">Filters</h5>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
              Filter
            </div>
          
          
          
            
          </div>


        <div class="offcanvas offcanvas-end" tabindex="-1" id="layout" aria-labelledby="offcanvasRightLabel">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasRightLabel">Edit Layout</h5>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
              Edit Layouts
            </div>
          
          
          
            
          </div>


        
        <div class="offcanvas offcanvas-end" tabindex="-1" id="settingbtn" aria-labelledby="offcanvasRightLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasRightLabel">Settings</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    Settings
  </div>




</div>

 

<script>
    // Firebase Configuration (Replace with your actual config)
    const firebaseConfig = {
     apiKey: "AIzaSyByY_StlwAyml1ZzhTjT9hxAZJIEUpYOYI",
     authDomain: "fir-slickgrid-app.firebaseapp.com",
     databaseURL: "https://fir-slickgrid-app-default-rtdb.firebaseio.com",
     projectId: "fir-slickgrid-app",
     storageBucket: "fir-slickgrid-app.firebasestorage.app",
     messagingSenderId: "632345189503",
     appId: "1:632345189503:web:5ea427e9d8ce2ea5cc734a"
 };

 // Initialize Firebase
 const app = firebase.initializeApp(firebaseConfig);
 const db = firebase.database(app);
 const dbRef = firebase.database().ref('tasks'); // Path in your Firebase Realtime Database

 var tableData = []; // Will be populated from Firebase
 var table; // Tabulator instance



 function transformData(firebaseData) {

const dataFromFirebase = firebaseData;        
// 1. Filter out rows with Budget_Item_Name and Item_Name

const firstfilter = firebaseData.filter(item => item.Budget_Item_Name && item.Item_Name);        
const filteredArcheivedDone = firstfilter.filter(item => item.PO_Status === "Archeived/Done");
const filteredSubmited = filteredArcheivedDone.filter(item => item.PR_Status === "Submited");

const filteredData = filteredSubmited;


// 2. Group data by Parent Budget Line
const groupedData = {};
filteredData.forEach(item => {
 const budgetItemName = item.Budget_Item_Name;






 if (budgetItemName) {
     const parts = budgetItemName.split('.');
     if (parts.length > 1) {
         parts.pop();
         const parentBudgetLine = parts.join('.');

         const rowtext = findMatchedWBS(parentBudgetLine,dataFromFirebase);



         if (!groupedData[parentBudgetLine]) {
             groupedData[parentBudgetLine] = {
                 children: [],
                 parentName: `${parentBudgetLine} ${rowtext} `, // Placeholder
                 totalSpent: 0
             };
         }
         groupedData[parentBudgetLine].children.push(item);


       let spentValue = item.Spent;
         // Robust Spent value handling:
    if (spentValue === undefined || spentValue === null) {
             spentValue = 0; // Treat undefined or null as 0
          //  console.warn(`Item with Budget_Item_Name: ${item.Budget_Item_Name} has undefined or null Spent. Treating as 0.`);
         } else if (typeof spentValue === 'string') {
             spentValue = parseFloat(spentValue.replace(/[^0-9.-]+/g, '')); // Remove non-numeric characters and parse
             if (isNaN(spentValue)) {
                 spentValue = 0; // Treat as 0 if parsing fails
               //  console.error(`Item with Budget_Item_Name: ${item.Budget_Item_Name} has invalid Spent value (string that can't be parsed): "${item.Spent}". Treating as 0.`);
             }
         } else if (typeof spentValue === 'number') {
             if (isNaN(spentValue)) {
                 spentValue = 0; // Treat NaN as 0 (shouldn't happen if data is correct numbers)
             //    console.error(`Item with Budget_Item_Name: ${item.Budget_Item_Name} has NaN Spent value (number is NaN). Treating as 0.`);
             }
         } else {
             spentValue = 0; // Default to 0 for other unexpected types
            // console.error(`Item with Budget_Item_Name: ${item.Budget_Item_Name} has unexpected Spent data type: ${typeof spentValue}. Treating as 0.`);
         }


         groupedData[parentBudgetLine].totalSpent += spentValue;

        // console.log("Processing item:", item.Budget_Item_Name, item.Item_Name, "Spent:", item.Spent, "Parsed Spent:", spentValue, "Parent WBS:", parentBudgetLine);


     }
 }
});

// console.log("Grouped Data Structure:", groupedData);


// 3. Construct final data array
const transformedTableData = [];
Object.keys(groupedData).forEach(parentBudgetLine => {
 transformedTableData.push(...groupedData[parentBudgetLine].children);
 transformedTableData.push({
     Budget_Item_Name: parentBudgetLine,
     Item_Name: groupedData[parentBudgetLine].parentName,
     Spent: groupedData[parentBudgetLine].totalSpent,
     isParentRow: true
 });
});

//console.log("Final Transformed Data for Tabulator:", transformedTableData);


if (Object.keys(groupedData).length === 0) {
 return filteredData;
}
return transformedTableData;
}




function findMatchedWBS(parentBudgetLine,dataFromFirebase){



const foundObject = dataFromFirebase.find(item => item.WBS_Code === parentBudgetLine);
if (foundObject) {

return foundObject.text;

}

}








function initializeTable(data) {
     table = new Tabulator("#example-table", {
         height: "100%",
         data: data, // Use transformed data
         layout: "fitColumns",
         movableColumns: true,
         selectable:false, // prevent user from selecting row,
         columns: [
             { title: "Budget Line", field: "Budget_Item_Name", width: 170, hozAlign:"center",   editable:false },
             { title: "Donor Fin_Code", field: "Fin_Code", width: 170, hozAlign:"center",   editable:false},
             { title: "PR Status", field: "PR_Status", width: 150,  editorParams:{values:["Not Started", "Prepared", "Submited", "Canceled"]}, editable: true, headerFilter:"list", headerFilterParams:{values:["Not Started", "Prepared", "Submited", "Canceled"]} },
             {title:"PR Date", field:"PR_Date", width: 150, formatter:function(cell, formatterParams, onRendered){
       var PR_Date = cell.getValue();
       if (PR_Date === undefined){
               return "" ;
           } else {
               intdate = new Date(PR_Date);
       var year = intdate.getFullYear();
       var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
       var month = months[intdate.getMonth()];
       var date = intdate.getDate();
       var time = date + ' ' + month + ' ' + year;  
           return time; //return the contents of the cell;
           } 
       }},
             { title: "PO Status", field: "PO_Status", width: 150,  editorParams:{values:["Not Started", "Paid/Deleivered", "Archeived/Done", "Canceled"]}, editable: true, headerFilter:"list", headerFilterParams:{values:["Not Started", "Paid/Deleivered", "Archeived/Done", "Canceled"]} },
             {title:"PO Date", field:"PO_Date", width: 150, formatter:function(cell, formatterParams, onRendered){
       var PO_Date = cell.getValue();
       if (PO_Date === undefined){
               return "" ;
           } else {
               intdate = new Date(PO_Date);
       var year = intdate.getFullYear();
       var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
       var month = months[intdate.getMonth()];
       var date = intdate.getDate();
       var time = date + ' ' + month + ' ' + year;  
           return time; //return the contents of the cell;
           } 
       }},
             { title: "PR/PO NAME", field: "Item_Name", width: 450, editable: false,   frozen:true },
             { title: "Spent", field: "Spent", width: 170, hozAlign:"center",  editor:"number", editable: false, },
             { title: "Fin/Log Description", field: "Fin_Log_Description", width: 300, editable: true, headerFilter:true },
             { title: "Parent Item Name", field: "Parent_Item", width: 350, editable: true, headerFilter:true  },
         ],
         rowFormatter: function(row) { // Style parent rows
var data = row.getData();
if (data.isParentRow) {
row.getElement().style.fontWeight = "bold"; // Make parent row text bold
row.getElement().style.backgroundColor = "#58d68d"; // Give parent rows a light grey background
}
},

     });



 }


 // Load data from Firebase and update table
 dbRef.on('value', (snapshot) => {
     let firebaseData = snapshot.val();
     if (firebaseData) {
         // Convert Firebase object to array
         const dataArray = Object.keys(firebaseData).map(key => ({
             id: key, // Keep Firebase key as 'id' for updates/deletes
             ...firebaseData[key]
         }));

         const filteredArcheivedDone = dataArray.filter(item => item.PO_Status === "Archeived/Done");
         const filteredSubmited = filteredArcheivedDone.filter(item => item.PR_Status === "Submited");
//console.log("Filtered for PO_Status 'Archeived/Done':", filteredArcheivedDone);

//console.log("Filtered for PO_Status 'Archeived/Done':", filteredSubmited);



         //If I want to filter I should pass the filteredArcheivedDone or alternative 


         //Used to be 
         //const transformedData = transformData(dataArray); // Transform the data
         const transformedData = transformData(dataArray); // Transform the data
         if (table) { // If table is already initialized, replace data
             table.replaceData(transformedData);
         } else { // Initialize table for the first time
             initializeTable(transformedData);
         }


     } else {
         if (table) {
             table.replaceData([]);
         } else {
             initializeTable([]);
         }
     }
 }, (errorObject) => {
     console.error("Data read failed: " + errorObject.name);
 });











</script>



<footer class="cm-footer" style = "height:1px">

  
</footer>




<!-- The Clearmin Dashboard JavaScript Libraries -->
<script src="Sources/Clearmin_Dashboard_All.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>


</body>      
</html>
